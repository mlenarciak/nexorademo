# Clerk Webhook Secret Setup

## Quick Answer

The **Clerk Webhook Secret** is generated by Clerk when you create a webhook endpoint. It starts with `whsec_`.

## Step-by-Step Guide

### 1. Get Clerk API Keys First

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Sign up or login
3. Create a new application (or select existing)
4. Click **API Keys** in sidebar
5. Copy these values:

```bash
# Add to apps/app/.env.local and apps/api/.env.local:
CLERK_SECRET_KEY=sk_test_xxxxxxxxxxxxx
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxx
```

### 2. Set Up Webhook (For Production)

1. In Clerk Dashboard, click **Webhooks** in sidebar
2. Click **Add Endpoint** button
3. Enter your webhook URL:
   - Production: `https://your-api-domain.com/webhooks/auth`
   - Staging: `https://your-staging-api.com/webhooks/auth`

4. Select **Message Filtering** events:
   - ‚úÖ `user.created`
   - ‚úÖ `user.updated`
   - ‚úÖ `user.deleted`
   - ‚úÖ `organization.created`
   - ‚úÖ `organization.updated`
   - ‚úÖ `organizationMembership.created`
   - ‚úÖ `organizationMembership.deleted`

5. Click **Create**

6. On the webhook details page:
   - Click the **üëÅÔ∏è eye icon** next to "Signing Secret"
   - Copy the secret (starts with `whsec_`)

```bash
# Add to apps/app/.env.local and apps/api/.env.local:
CLERK_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxx
```

### 3. Local Development (Optional)

For local development, webhooks are **optional** because:
- The code checks if `CLERK_WEBHOOK_SECRET` exists before validating
- You can test most features without webhooks
- Webhooks are mainly for syncing user data and analytics

#### Option A: Skip Webhooks Locally (Easiest)

Just use dummy/test values for the webhook secret:

```bash
# This will pass validation but webhooks won't work
CLERK_WEBHOOK_SECRET=whsec_test_placeholder_for_local_dev_only
```

#### Option B: Use Webhooks Locally (Advanced)

If you need to test webhooks locally:

1. Install ngrok or similar tunnel:
```bash
npx ngrok http 3002
```

2. Copy the https URL (e.g., `https://abcd1234.ngrok.io`)

3. In Clerk Dashboard:
   - Create a new webhook endpoint
   - URL: `https://abcd1234.ngrok.io/webhooks/auth`
   - Copy the signing secret

4. Update your `.env.local`:
```bash
CLERK_WEBHOOK_SECRET=whsec_from_ngrok_endpoint
```

**Note:** ngrok URLs change each time you restart, so you'll need to:
- Update the webhook URL in Clerk Dashboard, OR
- Use a paid ngrok account with a fixed subdomain

## What the Webhook Does

Your app's webhook endpoint (`/webhooks/auth`) receives notifications from Clerk when:

- **User created** ‚Üí Tracks user signup in analytics
- **User updated** ‚Üí Updates user profile data
- **User deleted** ‚Üí Marks user as deleted in analytics
- **Organization events** ‚Üí Syncs organization/team data

## Validation in Your Code

The webhook secret is used to verify that requests are really from Clerk:

```typescript
// From apps/api/app/webhooks/auth/route.ts
const webhook = new Webhook(env.CLERK_WEBHOOK_SECRET);
event = webhook.verify(body, {
  "svix-id": svixId,
  "svix-timestamp": svixTimestamp,
  "svix-signature": svixSignature,
});
```

This prevents malicious actors from sending fake webhook events.

## Troubleshooting

### "Invalid string: must start with whsec_"

**Problem:** The value you set doesn't start with `whsec_`

**Solutions:**
1. Make sure you copied the **Signing Secret**, not another value
2. Check for extra spaces or quotes in the `.env.local` file
3. Use a placeholder: `whsec_test_placeholder` (won't work but passes validation)

### "Webhook not configured"

**Problem:** `CLERK_WEBHOOK_SECRET` is empty or not set

**Solution:** This is OK for local dev! The app will skip webhook validation.

### Webhook events not being received

**Possible causes:**
1. Webhook URL is wrong (check Clerk Dashboard)
2. Your API is not publicly accessible (use ngrok for local dev)
3. Firewall blocking incoming requests
4. Check Clerk Dashboard ‚Üí Webhooks ‚Üí Endpoint ‚Üí "Recent Events" for errors

## Summary

**For Local Development:**
```bash
# Option 1: Use placeholder (webhooks won't work but app will run)
CLERK_WEBHOOK_SECRET=whsec_test_local_placeholder

# Option 2: Skip it entirely (comment out or remove)
# CLERK_WEBHOOK_SECRET=

# Option 3: Use ngrok for real webhooks
CLERK_WEBHOOK_SECRET=whsec_actual_secret_from_ngrok_endpoint
```

**For Production:**
```bash
# Always use real webhook secret from Clerk Dashboard
CLERK_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## Next Steps

After setting up Clerk:

1. **Test authentication:**
   - Start your app: `pnpm run dev`
   - Visit http://localhost:3000
   - Try signing up/signing in

2. **Monitor webhooks:**
   - Clerk Dashboard ‚Üí Webhooks ‚Üí Your Endpoint
   - View "Recent Events" to see webhook calls

3. **Check analytics:**
   - If you have PostHog or similar configured
   - User events should appear after sign up

## Quick Commands

```bash
# Edit environment files
nano apps/app/.env.local
nano apps/api/.env.local

# Test if env vars are loaded
cd apps/app && node -e "require('dotenv').config(); console.log(process.env.CLERK_SECRET_KEY)"

# Start development server
pnpm run dev

# Start just the API app
pnpm --filter api dev

# View logs
# Check terminal output for "Webhook" log messages
```

